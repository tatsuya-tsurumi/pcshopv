<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<title>ログイン</title>
<link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4EdSfo6FF_hNvHoorq5vIIAipia3zrB0&libraries=places"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>
<body>

	<h2>ログイン</h2>
	
	<div class="user_regist"><a th:href="regist" class="regist_btn">新規登録</a></div>
	
	<p th:text="${login_msg}" class="login_msg"></p>
	
	<form th:action="@{login-execute}" method="post">
		ユーザID&emsp;:<input type="text" name="userId" required ><br>
		パスワード:<input type="password" name="password" ><br><br>
		<input type="submit" value="ログイン">
	</form>
	
	<h2>地図の埋め込み</h2>
<div id="map"></div>
    <script>
        function initMap() {
            // 地図の初期設定
            const map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 35.7570, lng: 139.3625 }, // 東京の座標
                zoom: 14,
            });

            // Places API を使って病院を検索
            const request = {
                location: { lat: 35.7570, lng: 139.3625 }, // 東京の座標
                radius: 5000, // 検索範囲（メートル）
                type: "hospital", // 病院のみ
            };

            const service = new google.maps.places.PlacesService(map);
            const infoWindow = new google.maps.InfoWindow(); // 情報ウィンドウを作成

            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    results.forEach((place) => {
                        createMarker(place, map, infoWindow);
                    });
                } else {
                    console.error("Places APIのリクエストに失敗しました: " + status);
                }
            });
        }

    // マーカー作成とクリックイベントの設定
        function createMarker(place, map, infoWindow) {
            if (!place.geometry || !place.geometry.location) return;

            const marker = new google.maps.Marker({
                map,
                position: place.geometry.location,
                title: place.name, // マーカーに病院名を設定
            });

            // 詳細情報を取得してクリックイベントに設定
            google.maps.event.addListener(marker, "click", () => {
                const service = new google.maps.places.PlacesService(map);
                service.getDetails({ placeId: place.place_id }, (placeDetail, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        const content = `
                            <div>
                                <h3>${placeDetail.name}</h3>
                                <p>住所: ${placeDetail.vicinity || "情報なし"}</p>
                                <p>評価: ${placeDetail.rating || "評価なし"}</p>
                                <p><a href="${placeDetail.url}" target="_blank">Google Mapsで見る</a></p>
                                <p><a href="prod-list">商品選択</a></p>
                            </div>
                        `;
                        infoWindow.setContent(content); // 情報ウィンドウの内容を設定
                        infoWindow.open(map, marker); // 情報ウィンドウを表示
                    } else {
                        console.error("詳細情報の取得に失敗しました: " + status);
                    }
                });
            });
        }

        // 地図の初期化
        window.onload = initMap;
    </script>
</body>
</html>